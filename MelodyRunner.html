<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melody Runner - A Musical Platformer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            overflow: hidden;
        }
        
        .game-title {
            text-shadow: 4px 4px 0px #ff6b6b, 8px 8px 0px #4ecdc4;
        }
        
        .pixel-border {
            border: 4px solid #fff;
            box-shadow: 
                inset -4px -4px 0px 0px #aaa,
                inset 4px 4px 0px 0px #fff,
                8px 8px 0px 0px rgba(0,0,0,0.3);
        }
        
        .piano-key {
            transition: transform 0.05s, box-shadow 0.05s;
            cursor: pointer;
            user-select: none;
        }
        
        .piano-key:active, .piano-key.pressed {
            transform: translateY(4px);
            box-shadow: inset 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .piano-key.white-key {
            background: linear-gradient(180deg, #fff 0%, #e8e8e8 100%);
            border: 2px solid #333;
        }
        
        .piano-key.white-key:active, .piano-key.white-key.pressed {
            background: linear-gradient(180deg, #ddd 0%, #ccc 100%);
        }
        
        #gameCanvas {
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .heart {
            filter: drop-shadow(2px 2px 0px rgba(0,0,0,0.5));
        }
        
        .coin-icon {
            animation: spin 2s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .float-anim {
            animation: float 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .pulse-anim {
            animation: pulse 1s ease-in-out infinite;
        }
        
        .menu-btn {
            transition: all 0.2s;
            position: relative;
        }
        
        .menu-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(78, 205, 196, 0.5);
        }
        
        .menu-btn::before {
            content: '‚ô™';
            position: absolute;
            left: 10px;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .menu-btn:hover::before {
            opacity: 1;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center">
    <!-- Main Menu Screen -->
    <div id="mainMenu" class="flex flex-col items-center justify-center min-h-screen w-full p-4">
        <div class="text-center mb-8">
            <h1 class="game-title text-4xl md:text-6xl text-yellow-300 mb-4">MELODY</h1>
            <h1 class="game-title text-4xl md:text-6xl text-pink-400 mb-6">RUNNER</h1>
            <p class="text-white text-xs md:text-sm opacity-80">A Musical Platformer Adventure</p>
        </div>
        
        <div class="flex flex-col gap-4 w-full max-w-xs">
            <button onclick="startGame()" class="menu-btn pixel-border bg-gradient-to-r from-green-500 to-green-600 text-white py-4 px-8 text-sm hover:from-green-400 hover:to-green-500">
                üéµ START GAME
            </button>
            <button onclick="showScreen('howToPlay')" class="menu-btn pixel-border bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 px-8 text-sm hover:from-blue-400 hover:to-blue-500">
                üìñ HOW TO PLAY
            </button>
            <button onclick="showScreen('controls')" class="menu-btn pixel-border bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 px-8 text-sm hover:from-purple-400 hover:to-purple-500">
                üéπ CONTROLS
            </button>
        </div>
        
        <div class="mt-8 text-center">
            <p class="text-gray-400 text-xs">Play the piano to move!</p>
            <div class="flex justify-center mt-4 gap-1">
                <div class="w-8 h-12 bg-white rounded-b text-black text-xs flex items-end justify-center pb-1">C</div>
                <div class="w-8 h-12 bg-white rounded-b text-black text-xs flex items-end justify-center pb-1">D</div>
                <div class="w-8 h-12 bg-white rounded-b text-black text-xs flex items-end justify-center pb-1">E</div>
                <div class="w-8 h-12 bg-white rounded-b text-black text-xs flex items-end justify-center pb-1">F</div>
                <div class="w-8 h-12 bg-white rounded-b text-black text-xs flex items-end justify-center pb-1">G</div>
            </div>
        </div>
    </div>

    <!-- How To Play Screen -->
    <div id="howToPlay" class="hidden flex flex-col items-center justify-center min-h-screen w-full p-4">
        <div class="pixel-border bg-gray-900 bg-opacity-90 p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <h2 class="text-2xl text-yellow-300 mb-6 text-center">HOW TO PLAY</h2>
            
            <div class="space-y-4 text-white text-xs leading-relaxed">
                <div class="bg-gray-800 p-4 rounded">
                    <h3 class="text-green-400 mb-2">üéØ OBJECTIVE</h3>
                    <p>Guide your character through each level by playing piano keys! Collect the required number of coins and reach the goal flag to advance.</p>
                </div>
                
                <div class="bg-gray-800 p-4 rounded">
                    <h3 class="text-blue-400 mb-2">ü™ô COINS</h3>
                    <p>Each level requires a minimum number of coins to complete. Coins are placed in tricky spots - you'll need good timing and musical skills to grab them all!</p>
                </div>
                
                <div class="bg-gray-800 p-4 rounded">
                    <h3 class="text-red-400 mb-2">‚ù§Ô∏è HEARTS & ENEMIES</h3>
                    <p>You start with 3 hearts. Touch an enemy and you lose 1 heart and restart the level. Lose all hearts? GAME OVER - back to the beginning!</p>
                </div>
                
                <div class="bg-gray-800 p-4 rounded">
                    <h3 class="text-purple-400 mb-2">üó∫Ô∏è PROGRESSION</h3>
                    <p>Complete all 5 levels in a map to unlock the next map. Each map gets progressively harder with more enemies, trickier platforms, and more coins to collect!</p>
                </div>
                
                <div class="bg-gray-800 p-4 rounded">
                    <h3 class="text-yellow-400 mb-2">üí° TIPS</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li>Hold keys to sustain movement</li>
                        <li>Combine keys for diagonal movement</li>
                        <li>Use dash (F) to cross gaps quickly</li>
                        <li>Time your jumps with the music!</li>
                    </ul>
                </div>
            </div>
            
            <button onclick="showScreen('mainMenu')" class="mt-6 pixel-border bg-gray-700 text-white py-3 px-6 text-xs w-full hover:bg-gray-600">
                ‚Üê BACK TO MENU
            </button>
        </div>
    </div>

    <!-- Controls Screen -->
    <div id="controls" class="hidden flex flex-col items-center justify-center min-h-screen w-full p-4">
        <div class="pixel-border bg-gray-900 bg-opacity-90 p-6 max-w-2xl w-full">
            <h2 class="text-2xl text-yellow-300 mb-6 text-center">CONTROLS</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-white text-xs">
                <div class="bg-gradient-to-r from-red-600 to-red-700 p-4 rounded flex items-center gap-4">
                    <div class="w-16 h-20 bg-white rounded-b text-black flex flex-col items-center justify-end pb-2">
                        <span class="text-lg font-bold">C</span>
                        <span class="text-xs opacity-70">Key: A</span>
                    </div>
                    <div>
                        <h3 class="text-lg mb-1">‚Üê MOVE LEFT</h3>
                        <p class="opacity-80">Hold to walk left</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-orange-600 to-orange-700 p-4 rounded flex items-center gap-4">
                    <div class="w-16 h-20 bg-white rounded-b text-black flex flex-col items-center justify-end pb-2">
                        <span class="text-lg font-bold">D</span>
                        <span class="text-xs opacity-70">Key: S</span>
                    </div>
                    <div>
                        <h3 class="text-lg mb-1">‚Üë JUMP</h3>
                        <p class="opacity-80">Press to jump up</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-yellow-600 to-yellow-700 p-4 rounded flex items-center gap-4">
                    <div class="w-16 h-20 bg-white rounded-b text-black flex flex-col items-center justify-end pb-2">
                        <span class="text-lg font-bold">E</span>
                        <span class="text-xs opacity-70">Key: D</span>
                    </div>
                    <div>
                        <h3 class="text-lg mb-1">‚Üí MOVE RIGHT</h3>
                        <p class="opacity-80">Hold to walk right</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-green-600 to-green-700 p-4 rounded flex items-center gap-4">
                    <div class="w-16 h-20 bg-white rounded-b text-black flex flex-col items-center justify-end pb-2">
                        <span class="text-lg font-bold">F</span>
                        <span class="text-xs opacity-70">Key: F</span>
                    </div>
                    <div>
                        <h3 class="text-lg mb-1">‚ö° DASH</h3>
                        <p class="opacity-80">Quick burst of speed</p>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 p-4 rounded flex items-center gap-4 md:col-span-2 md:w-1/2 md:mx-auto">
                    <div class="w-16 h-20 bg-white rounded-b text-black flex flex-col items-center justify-end pb-2">
                        <span class="text-lg font-bold">G</span>
                        <span class="text-xs opacity-70">Key: G</span>
                    </div>
                    <div>
                        <h3 class="text-lg mb-1">‚¨á CROUCH</h3>
                        <p class="opacity-80">Duck under obstacles</p>
                    </div>
                </div>
            </div>
            
            <div class="mt-6 text-center text-gray-400 text-xs">
                <p>Click piano keys or use keyboard (A, S, D, F, G)</p>
                <p class="mt-2">Press ESC during gameplay to pause</p>
            </div>
            
            <button onclick="showScreen('mainMenu')" class="mt-6 pixel-border bg-gray-700 text-white py-3 px-6 text-xs w-full hover:bg-gray-600">
                ‚Üê BACK TO MENU
            </button>
        </div>
    </div>

    <!-- Game Screen -->
    <div id="gameScreen" class="hidden flex flex-col items-center w-full h-screen">
        <!-- Game UI -->
        <div id="gameUI" class="w-full max-w-4xl px-4 py-2 flex justify-between items-center bg-gray-900 bg-opacity-80">
            <div class="flex items-center gap-2">
                <span id="hearts" class="flex gap-1">
                    <span class="heart text-2xl">‚ù§Ô∏è</span>
                    <span class="heart text-2xl">‚ù§Ô∏è</span>
                    <span class="heart text-2xl">‚ù§Ô∏è</span>
                </span>
            </div>
            <div class="text-white text-xs text-center">
                <span id="mapLevel" class="text-yellow-300">MAP 1 - LEVEL 1</span>
            </div>
            <div class="flex items-center gap-2 text-white text-sm">
                <span class="coin-icon text-xl">ü™ô</span>
                <span id="coinCount" class="text-yellow-300">0</span>
                <span>/</span>
                <span id="coinRequired" class="text-green-300">3</span>
            </div>
        </div>
        
        <!-- Game Canvas -->
        <div class="flex-1 w-full max-w-4xl bg-gray-800 relative overflow-hidden">
            <canvas id="gameCanvas" class="w-full h-full"></canvas>
            
            <!-- Level Complete Overlay -->
            <div id="levelComplete" class="hidden absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center">
                <h2 class="text-3xl text-green-400 mb-4 float-anim">LEVEL COMPLETE!</h2>
                <p class="text-white text-sm mb-6">üéµ Perfect Melody! üéµ</p>
                <button onclick="nextLevel()" class="pixel-border bg-green-600 text-white py-3 px-8 text-sm hover:bg-green-500">
                    NEXT LEVEL ‚Üí
                </button>
            </div>
            
            <!-- Game Over Overlay -->
            <div id="gameOver" class="hidden absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center">
                <h2 class="text-4xl text-red-500 mb-4 pulse-anim">GAME OVER</h2>
                <p class="text-gray-400 text-sm mb-2">The melody has ended...</p>
                <p class="text-white text-xs mb-6">Final Score: <span id="finalScore" class="text-yellow-300">0</span> coins</p>
                <button onclick="restartGame()" class="pixel-border bg-red-600 text-white py-3 px-8 text-sm hover:bg-red-500">
                    TRY AGAIN
                </button>
                <button onclick="showScreen('mainMenu'); hideOverlays();" class="mt-4 text-gray-400 text-xs hover:text-white">
                    Return to Menu
                </button>
            </div>
            
            <!-- Pause Overlay -->
            <div id="pauseMenu" class="hidden absolute inset-0 bg-black bg-opacity-80 flex flex-col items-center justify-center">
                <h2 class="text-3xl text-yellow-300 mb-6">PAUSED</h2>
                <button onclick="resumeGame()" class="pixel-border bg-green-600 text-white py-3 px-8 text-sm mb-4 hover:bg-green-500">
                    RESUME
                </button>
                <button onclick="restartLevel()" class="pixel-border bg-orange-600 text-white py-3 px-8 text-sm mb-4 hover:bg-orange-500">
                    RESTART LEVEL
                </button>
                <button onclick="showScreen('mainMenu'); hideOverlays();" class="pixel-border bg-gray-600 text-white py-3 px-8 text-sm hover:bg-gray-500">
                    QUIT TO MENU
                </button>
            </div>
            
            <!-- Map Complete Overlay -->
            <div id="mapComplete" class="hidden absolute inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center">
                <h2 class="text-3xl text-yellow-300 mb-4 float-anim">üéâ MAP COMPLETE! üéâ</h2>
                <p class="text-white text-sm mb-6">You've mastered this musical realm!</p>
                <button onclick="nextMap()" class="pixel-border bg-purple-600 text-white py-3 px-8 text-sm hover:bg-purple-500">
                    NEXT MAP ‚Üí
                </button>
            </div>
            
            <!-- Victory Overlay -->
            <div id="victory" class="hidden absolute inset-0 bg-gradient-to-b from-purple-900 to-black flex flex-col items-center justify-center">
                <h2 class="text-4xl text-yellow-300 mb-4 float-anim">üèÜ VICTORY! üèÜ</h2>
                <p class="text-white text-lg mb-2">You are a true Melody Master!</p>
                <p class="text-gray-400 text-sm mb-6">Total Coins: <span id="totalCoins" class="text-yellow-300">0</span></p>
                <button onclick="showScreen('mainMenu'); hideOverlays();" class="pixel-border bg-yellow-600 text-white py-3 px-8 text-sm hover:bg-yellow-500">
                    BACK TO MENU
                </button>
            </div>
        </div>
        
        <!-- Piano Controller -->
        <div id="pianoController" class="w-full max-w-4xl bg-gradient-to-b from-gray-800 to-gray-900 p-4">
            <div class="flex justify-center gap-1">
                <div id="keyC" class="piano-key white-key w-14 md:w-20 h-32 md:h-40 rounded-b-lg flex flex-col items-center justify-end pb-4 relative"
                     onmousedown="pressKey('C')" onmouseup="releaseKey('C')" onmouseleave="releaseKey('C')"
                     ontouchstart="pressKey('C'); event.preventDefault();" ontouchend="releaseKey('C')">
                    <span class="text-black text-lg font-bold">C</span>
                    <span class="text-gray-500 text-xs mt-1">A</span>
                    <span class="text-red-500 text-xs mt-1">‚Üê</span>
                </div>
                <div id="keyD" class="piano-key white-key w-14 md:w-20 h-32 md:h-40 rounded-b-lg flex flex-col items-center justify-end pb-4 relative"
                     onmousedown="pressKey('D')" onmouseup="releaseKey('D')" onmouseleave="releaseKey('D')"
                     ontouchstart="pressKey('D'); event.preventDefault();" ontouchend="releaseKey('D')">
                    <span class="text-black text-lg font-bold">D</span>
                    <span class="text-gray-500 text-xs mt-1">S</span>
                    <span class="text-orange-500 text-xs mt-1">‚Üë</span>
                </div>
                <div id="keyE" class="piano-key white-key w-14 md:w-20 h-32 md:h-40 rounded-b-lg flex flex-col items-center justify-end pb-4 relative"
                     onmousedown="pressKey('E')" onmouseup="releaseKey('E')" onmouseleave="releaseKey('E')"
                     ontouchstart="pressKey('E'); event.preventDefault();" ontouchend="releaseKey('E')">
                    <span class="text-black text-lg font-bold">E</span>
                    <span class="text-gray-500 text-xs mt-1">D</span>
                    <span class="text-yellow-500 text-xs mt-1">‚Üí</span>
                </div>
                <div id="keyF" class="piano-key white-key w-14 md:w-20 h-32 md:h-40 rounded-b-lg flex flex-col items-center justify-end pb-4 relative"
                     onmousedown="pressKey('F')" onmouseup="releaseKey('F')" onmouseleave="releaseKey('F')"
                     ontouchstart="pressKey('F'); event.preventDefault();" ontouchend="releaseKey('F')">
                    <span class="text-black text-lg font-bold">F</span>
                    <span class="text-gray-500 text-xs mt-1">F</span>
                    <span class="text-green-500 text-xs mt-1">‚ö°</span>
                </div>
                <div id="keyG" class="piano-key white-key w-14 md:w-20 h-32 md:h-40 rounded-b-lg flex flex-col items-center justify-end pb-4 relative"
                     onmousedown="pressKey('G')" onmouseup="releaseKey('G')" onmouseleave="releaseKey('G')"
                     ontouchstart="pressKey('G'); event.preventDefault();" ontouchend="releaseKey('G')">
                    <span class="text-black text-lg font-bold">G</span>
                    <span class="text-gray-500 text-xs mt-1">G</span>
                    <span class="text-blue-500 text-xs mt-1">‚¨á</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==================== REALISTIC PIANO AUDIO SYSTEM ====================
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        let audioCtx = null;
        let masterGain = null;
        let reverbNode = null;
        const activeNotes = {};
        
        // Piano note frequencies (C4 to G4)
        const noteFrequencies = {
            'C': 261.63,
            'D': 293.66,
            'E': 329.63,
            'F': 349.23,
            'G': 392.00
        };
        
        // Harmonic ratios for realistic piano sound
        // Real pianos have slight inharmonicity - overtones are slightly sharp
        const harmonicRatios = [1, 2.001, 3.002, 4.004, 5.007, 6.01, 7.015, 8.02];
        const harmonicAmplitudes = [1.0, 0.5, 0.35, 0.25, 0.15, 0.1, 0.06, 0.03];
        
        function initAudio() {
            if (!audioCtx) {
                audioCtx = new AudioContext();
                
                // Create master gain
                masterGain = audioCtx.createGain();
                masterGain.gain.value = 0.6;
                
                // Create convolver for reverb effect
                reverbNode = createReverb();
                
                // Create dry/wet mix
                const dryGain = audioCtx.createGain();
                const wetGain = audioCtx.createGain();
                dryGain.gain.value = 0.7;
                wetGain.gain.value = 0.3;
                
                masterGain.connect(dryGain);
                masterGain.connect(reverbNode);
                reverbNode.connect(wetGain);
                
                dryGain.connect(audioCtx.destination);
                wetGain.connect(audioCtx.destination);
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }
        
        // Create impulse response for reverb
        function createReverb() {
            const convolver = audioCtx.createConvolver();
            const rate = audioCtx.sampleRate;
            const length = rate * 1.5; // 1.5 second reverb tail
            const impulse = audioCtx.createBuffer(2, length, rate);
            
            for (let channel = 0; channel < 2; channel++) {
                const channelData = impulse.getChannelData(channel);
                for (let i = 0; i < length; i++) {
                    // Exponential decay with some randomness for natural sound
                    channelData[i] = (Math.random() * 2 - 1) * Math.pow(1 - i / length, 2.5);
                }
            }
            
            convolver.buffer = impulse;
            return convolver;
        }
        
        // Create a realistic piano note with multiple harmonics and proper ADSR
        function playNote(note) {
            initAudio();
            if (activeNotes[note]) return;
            
            const fundamental = noteFrequencies[note];
            const now = audioCtx.currentTime;
            
            // Create nodes for this note
            const noteGain = audioCtx.createGain();
            const oscillators = [];
            const oscillatorGains = [];
            
            // Create a compressor for dynamics
            const compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.value = -24;
            compressor.knee.value = 30;
            compressor.ratio.value = 4;
            compressor.attack.value = 0.003;
            compressor.release.value = 0.25;
            
            // Add a subtle filter to simulate piano body resonance
            const bodyFilter = audioCtx.createBiquadFilter();
            bodyFilter.type = 'lowpass';
            bodyFilter.frequency.value = 4000;
            bodyFilter.Q.value = 0.5;
            
            // High-pass filter to remove rumble
            const highPass = audioCtx.createBiquadFilter();
            highPass.type = 'highpass';
            highPass.frequency.value = 80;
            
            // Create multiple oscillators for harmonics (simulating piano strings)
            for (let i = 0; i < harmonicRatios.length; i++) {
                const osc = audioCtx.createOscillator();
                const oscGain = audioCtx.createGain();
                
                // Use different waveforms for different harmonics
                if (i === 0) {
                    osc.type = 'sine'; // Fundamental is pure sine
                } else if (i < 3) {
                    osc.type = 'sine'; // Lower harmonics also sine
                } else {
                    osc.type = 'sine'; // All sine but with proper amplitude falloff
                }
                
                // Set frequency with slight detuning for richness
                const detune = (Math.random() - 0.5) * 4; // ¬±2 cents random detuning
                osc.frequency.value = fundamental * harmonicRatios[i];
                osc.detune.value = detune;
                
                // Set harmonic amplitude with ADSR envelope
                const amp = harmonicAmplitudes[i] * 0.15;
                
                // Higher harmonics decay faster (like real piano strings)
                const decayTime = 2.0 - (i * 0.15);
                
                // Attack - quick but not instant (hammer strike simulation)
                oscGain.gain.setValueAtTime(0, now);
                oscGain.gain.linearRampToValueAtTime(amp, now + 0.005); // 5ms attack
                
                // Initial decay (bright attack dies quickly)
                oscGain.gain.exponentialRampToValueAtTime(amp * 0.7, now + 0.05);
                
                // Sustain decay (slow natural decay while key held)
                oscGain.gain.exponentialRampToValueAtTime(amp * 0.4, now + 0.5);
                oscGain.gain.exponentialRampToValueAtTime(amp * 0.2, now + decayTime);
                
                osc.connect(oscGain);
                oscGain.connect(noteGain);
                
                osc.start(now);
                
                oscillators.push(osc);
                oscillatorGains.push(oscGain);
            }
            
            // Add subtle "hammer noise" for attack realism
            const noiseBuffer = createNoiseBuffer(0.03);
            const noiseSource = audioCtx.createBufferSource();
            const noiseGain = audioCtx.createGain();
            const noiseFilter = audioCtx.createBiquadFilter();
            
            noiseSource.buffer = noiseBuffer;
            noiseFilter.type = 'bandpass';
            noiseFilter.frequency.value = fundamental * 4;
            noiseFilter.Q.value = 2;
            
            noiseGain.gain.setValueAtTime(0.08, now);
            noiseGain.gain.exponentialRampToValueAtTime(0.001, now + 0.03);
            
            noiseSource.connect(noiseFilter);
            noiseFilter.connect(noiseGain);
            noiseGain.connect(noteGain);
            noiseSource.start(now);
            
            // Connect the signal chain
            noteGain.connect(highPass);
            highPass.connect(bodyFilter);
            bodyFilter.connect(compressor);
            compressor.connect(masterGain);
            
            // Store note data for release
            activeNotes[note] = {
                oscillators,
                oscillatorGains,
                noteGain,
                noiseSource,
                startTime: now
            };
        }
        
        // Create noise buffer for hammer attack
        function createNoiseBuffer(duration) {
            const sampleRate = audioCtx.sampleRate;
            const length = sampleRate * duration;
            const buffer = audioCtx.createBuffer(1, length, sampleRate);
            const data = buffer.getChannelData(0);
            
            for (let i = 0; i < length; i++) {
                data[i] = Math.random() * 2 - 1;
            }
            
            return buffer;
        }
        
        function stopNote(note) {
            if (!activeNotes[note]) return;
            
            const { oscillators, oscillatorGains, noteGain, noiseSource } = activeNotes[note];
            const now = audioCtx.currentTime;
            
            // Natural release - simulate damper falling on strings
            const releaseTime = 0.3; // 300ms release
            
            oscillatorGains.forEach((gain, index) => {
                // Cancel any scheduled changes
                gain.gain.cancelScheduledValues(now);
                // Set current value
                gain.gain.setValueAtTime(gain.gain.value, now);
                // Fade out with exponential curve (natural string damping)
                gain.gain.exponentialRampToValueAtTime(0.0001, now + releaseTime);
            });
            
            // Stop oscillators after release
            setTimeout(() => {
                oscillators.forEach(osc => {
                    try { osc.stop(); } catch(e) {}
                });
                try { noiseSource.stop(); } catch(e) {}
            }, releaseTime * 1000 + 50);
            
            delete activeNotes[note];
        }
        
        // Play a quick sound effect (for coins, etc.)
        function playSoundEffect(type) {
            initAudio();
            
            if (type === 'coin') {
                const now = audioCtx.currentTime;
                
                // Create a pleasant "ding" sound
                const osc1 = audioCtx.createOscillator();
                const osc2 = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                
                osc1.type = 'sine';
                osc2.type = 'sine';
                
                osc1.frequency.setValueAtTime(880, now);
                osc1.frequency.exponentialRampToValueAtTime(1760, now + 0.1);
                
                osc2.frequency.setValueAtTime(1320, now);
                osc2.frequency.exponentialRampToValueAtTime(2640, now + 0.1);
                
                gain.gain.setValueAtTime(0.15, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
                
                osc1.connect(gain);
                osc2.connect(gain);
                gain.connect(masterGain || audioCtx.destination);
                
                osc1.start(now);
                osc2.start(now);
                osc1.stop(now + 0.3);
                osc2.stop(now + 0.3);
            }
        }
        
        // ==================== INPUT HANDLING ====================
        const keys = { C: false, D: false, E: false, F: false, G: false };
        const keyMap = { 'a': 'C', 's': 'D', 'd': 'E', 'f': 'F', 'g': 'G' };
        
        function pressKey(note) {
            if (!keys[note]) {
                keys[note] = true;
                document.getElementById('key' + note).classList.add('pressed');
                playNote(note);
            }
        }
        
        function releaseKey(note) {
            if (keys[note]) {
                keys[note] = false;
                document.getElementById('key' + note).classList.remove('pressed');
                stopNote(note);
            }
        }
        
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && gameState === 'playing') {
                pauseGame();
                return;
            }
            const note = keyMap[e.key.toLowerCase()];
            if (note && !e.repeat) {
                pressKey(note);
            }
        });
        
        document.addEventListener('keyup', (e) => {
            const note = keyMap[e.key.toLowerCase()];
            if (note) {
                releaseKey(note);
            }
        });
        
        // ==================== GAME STATE ====================
        let gameState = 'menu';
        let currentMap = 0;
        let currentLevel = 0;
        let hearts = 3;
        let coins = 0;
        let totalCoins = 0;
        let isPaused = false;
        
        // ==================== PLAYER ====================
        const player = {
            x: 50,
            y: 200,
            width: 30,
            height: 40,
            vx: 0,
            vy: 0,
            speed: 4,
            jumpForce: -12,
            gravity: 0.5,
            grounded: false,
            crouching: false,
            dashCooldown: 0,
            facingRight: true,
            color: '#4ecdc4'
        };
        
        // ==================== LEVEL DATA ====================
        const maps = [
            // MAP 1: Grasslands
            {
                name: "Grasslands",
                bgColor: '#87CEEB',
                groundColor: '#8B4513',
                platformColor: '#228B22',
                levels: [
                    {
                        platforms: [
                            { x: 0, y: 350, w: 800, h: 50 },
                            { x: 200, y: 280, w: 100, h: 20 },
                            { x: 400, y: 220, w: 100, h: 20 },
                            { x: 600, y: 280, w: 100, h: 20 }
                        ],
                        coins: [
                            { x: 240, y: 250 },
                            { x: 440, y: 190 },
                            { x: 640, y: 250 }
                        ],
                        enemies: [],
                        goal: { x: 720, y: 300 },
                        required: 2,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 300, h: 50 },
                            { x: 350, y: 350, w: 150, h: 50 },
                            { x: 550, y: 350, w: 250, h: 50 },
                            { x: 150, y: 270, w: 80, h: 20 },
                            { x: 320, y: 200, w: 80, h: 20 },
                            { x: 500, y: 270, w: 80, h: 20 }
                        ],
                        coins: [
                            { x: 180, y: 240 },
                            { x: 350, y: 170 },
                            { x: 530, y: 240 },
                            { x: 700, y: 320 }
                        ],
                        enemies: [
                            { x: 400, y: 320, type: 'walker', range: 100 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 3,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 200, h: 50 },
                            { x: 250, y: 300, w: 80, h: 20 },
                            { x: 380, y: 250, w: 80, h: 20 },
                            { x: 510, y: 200, w: 80, h: 20 },
                            { x: 640, y: 150, w: 160, h: 20 },
                            { x: 640, y: 350, w: 160, h: 50 }
                        ],
                        coins: [
                            { x: 280, y: 270 },
                            { x: 410, y: 220 },
                            { x: 540, y: 170 },
                            { x: 700, y: 120 },
                            { x: 750, y: 120 }
                        ],
                        enemies: [
                            { x: 670, y: 120, type: 'jumper', range: 50 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 4,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 150, h: 50 },
                            { x: 200, y: 320, w: 60, h: 20 },
                            { x: 310, y: 280, w: 60, h: 20 },
                            { x: 420, y: 240, w: 60, h: 20 },
                            { x: 310, y: 200, w: 60, h: 20 },
                            { x: 200, y: 160, w: 60, h: 20 },
                            { x: 310, y: 120, w: 200, h: 20 },
                            { x: 550, y: 180, w: 80, h: 20 },
                            { x: 680, y: 250, w: 120, h: 20 },
                            { x: 680, y: 350, w: 120, h: 50 }
                        ],
                        coins: [
                            { x: 220, y: 290 },
                            { x: 330, y: 250 },
                            { x: 440, y: 210 },
                            { x: 330, y: 170 },
                            { x: 220, y: 130 },
                            { x: 400, y: 90 }
                        ],
                        enemies: [
                            { x: 350, y: 90, type: 'walker', range: 80 },
                            { x: 700, y: 220, type: 'walker', range: 60 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 5,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 100, h: 50 },
                            { x: 150, y: 300, w: 50, h: 20 },
                            { x: 250, y: 250, w: 50, h: 20 },
                            { x: 150, y: 200, w: 50, h: 20 },
                            { x: 250, y: 150, w: 50, h: 20 },
                            { x: 350, y: 200, w: 50, h: 20 },
                            { x: 450, y: 150, w: 50, h: 20 },
                            { x: 550, y: 200, w: 50, h: 20 },
                            { x: 450, y: 250, w: 50, h: 20 },
                            { x: 550, y: 300, w: 50, h: 20 },
                            { x: 650, y: 350, w: 150, h: 50 }
                        ],
                        coins: [
                            { x: 165, y: 270 },
                            { x: 265, y: 220 },
                            { x: 165, y: 170 },
                            { x: 265, y: 120 },
                            { x: 365, y: 170 },
                            { x: 465, y: 120 },
                            { x: 565, y: 170 },
                            { x: 465, y: 220 }
                        ],
                        enemies: [
                            { x: 200, y: 170, type: 'jumper', range: 30 },
                            { x: 500, y: 120, type: 'walker', range: 30 },
                            { x: 700, y: 320, type: 'walker', range: 50 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 6,
                        spawn: { x: 50, y: 300 }
                    }
                ]
            },
            // MAP 2: Crystal Caves
            {
                name: "Crystal Caves",
                bgColor: '#1a1a3e',
                groundColor: '#4a4a6a',
                platformColor: '#6a5acd',
                levels: [
                    {
                        platforms: [
                            { x: 0, y: 350, w: 200, h: 50 },
                            { x: 280, y: 320, w: 80, h: 20 },
                            { x: 440, y: 280, w: 80, h: 20 },
                            { x: 280, y: 220, w: 80, h: 20 },
                            { x: 440, y: 160, w: 80, h: 20 },
                            { x: 600, y: 200, w: 200, h: 20 },
                            { x: 600, y: 350, w: 200, h: 50 }
                        ],
                        coins: [
                            { x: 310, y: 290 },
                            { x: 470, y: 250 },
                            { x: 310, y: 190 },
                            { x: 470, y: 130 },
                            { x: 700, y: 170 }
                        ],
                        enemies: [
                            { x: 650, y: 170, type: 'crystal', range: 80 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 4,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 120, h: 50 },
                            { x: 180, y: 300, w: 60, h: 20 },
                            { x: 300, y: 250, w: 60, h: 20 },
                            { x: 180, y: 180, w: 60, h: 20 },
                            { x: 300, y: 120, w: 60, h: 20 },
                            { x: 420, y: 180, w: 60, h: 20 },
                            { x: 540, y: 120, w: 60, h: 20 },
                            { x: 420, y: 280, w: 60, h: 20 },
                            { x: 540, y: 220, w: 60, h: 20 },
                            { x: 660, y: 280, w: 140, h: 20 },
                            { x: 660, y: 350, w: 140, h: 50 }
                        ],
                        coins: [
                            { x: 200, y: 270 },
                            { x: 320, y: 220 },
                            { x: 200, y: 150 },
                            { x: 320, y: 90 },
                            { x: 440, y: 150 },
                            { x: 560, y: 90 },
                            { x: 440, y: 250 }
                        ],
                        enemies: [
                            { x: 300, y: 90, type: 'crystal', range: 40 },
                            { x: 540, y: 190, type: 'jumper', range: 40 },
                            { x: 700, y: 250, type: 'walker', range: 60 }
                        ],
                        goal: { x: 750, y: 300 },
                        required: 5,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 100, h: 50 },
                            { x: 150, y: 280, w: 50, h: 20 },
                            { x: 250, y: 350, w: 50, h: 50 },
                            { x: 350, y: 280, w: 50, h: 20 },
                            { x: 450, y: 350, w: 50, h: 50 },
                            { x: 350, y: 180, w: 50, h: 20 },
                            { x: 250, y: 120, w: 50, h: 20 },
                            { x: 450, y: 120, w: 50, h: 20 },
                            { x: 550, y: 180, w: 50, h: 20 },
                            { x: 650, y: 250, w: 50, h: 20 },
                            { x: 700, y: 350, w: 100, h: 50 }
                        ],
                        coins: [
                            { x: 165, y: 250 },
                            { x: 365, y: 250 },
                            { x: 365, y: 150 },
                            { x: 265, y: 90 },
                            { x: 465, y: 90 },
                            { x: 565, y: 150 },
                            { x: 665, y: 220 }
                        ],
                        enemies: [
                            { x: 275, y: 320, type: 'walker', range: 25 },
                            { x: 475, y: 320, type: 'jumper', range: 25 },
                            { x: 375, y: 150, type: 'crystal', range: 30 }
                        ],
                        goal: { x: 730, y: 300 },
                        required: 6,
                        spawn: { x: 50, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 80, h: 50 },
                            { x: 130, y: 310, w: 40, h: 15 },
                            { x: 220, y: 270, w: 40, h: 15 },
                            { x: 310, y: 230, w: 40, h: 15 },
                            { x: 400, y: 190, w: 40, h: 15 },
                            { x: 310, y: 150, w: 40, h: 15 },
                            { x: 220, y: 110, w: 40, h: 15 },
                            { x: 310, y: 70, w: 200, h: 15 },
                            { x: 530, y: 130, w: 40, h: 15 },
                            { x: 620, y: 190, w: 40, h: 15 },
                            { x: 530, y: 250, w: 40, h: 15 },
                            { x: 620, y: 310, w: 40, h: 15 },
                            { x: 700, y: 350, w: 100, h: 50 }
                        ],
                        coins: [
                            { x: 142, y: 280 },
                            { x: 232, y: 240 },
                            { x: 322, y: 200 },
                            { x: 412, y: 160 },
                            { x: 322, y: 120 },
                            { x: 232, y: 80 },
                            { x: 400, y: 40 },
                            { x: 542, y: 100 },
                            { x: 632, y: 160 },
                            { x: 542, y: 220 }
                        ],
                        enemies: [
                            { x: 350, y: 40, type: 'walker', range: 80 },
                            { x: 420, y: 160, type: 'crystal', range: 20 },
                            { x: 550, y: 220, type: 'jumper', range: 20 }
                        ],
                        goal: { x: 730, y: 300 },
                        required: 7,
                        spawn: { x: 40, y: 300 }
                    },
                    {
                        platforms: [
                            { x: 0, y: 350, w: 60, h: 50 },
                            { x: 100, y: 300, w: 40, h: 15 },
                            { x: 180, y: 250, w: 40, h: 15 },
                            { x: 260, y: 300, w: 40, h: 15 },
                            { x: 340, y: 250, w: 40, h: 15 },
                            { x: 260, y: 180, w: 40, h: 15 },
                            { x: 180, y: 130, w: 40, h: 15 },
                            { x: 260, y: 80, w: 40, h: 15 },
                            { x: 340, y: 130, w: 40, h: 15 },
                            { x: 420, y: 80, w: 100, h: 15 },
                            { x: 540, y: 130, w: 40, h: 15 },
                            { x: 620, y: 180, w: 40, h: 15 },
                            { x: 540, y: 230, w: 40, h: 15 },
                            { x: 620, y: 280, w: 40, h: 15 },
                            { x: 700, y: 350, w: 100, h: 50 }
                        ],
                        coins: [
                            { x: 112, y: 270 },
                            { x: 192, y: 220 },
                            { x: 272, y: 270 },
                            { x: 352, y: 220 },
                            { x: 272, y: 150 },
                            { x: 192, y: 100 },
                            { x: 272, y: 50 },
                            { x: 352, y: 100 },
                            { x: 460, y: 50 },
                            { x: 552, y: 100 },
                            { x: 632, y: 150 }
                        ],
                        enemies: [
                            { x: 280, y: 270, type: 'walker', range: 20 },
                            { x: 280, y: 50, type: 'jumper', range: 20 },
                            { x: 450, y: 50, type: 'crystal', range: 50 },
                            { x: 640, y: 250, type: 'walker', range: 20 },
                            { x: 730, y: 320, type: 'jumper', range: 30 }
                        ],
                        goal: { x: 740, y: 300 },
                        required: 8,
                        spawn: { x: 30, y: 300 }
                    }
                ]
            }
        ];
        
        // ==================== LEVEL OBJECTS ====================
        let platforms = [];
        let levelCoins = [];
        let enemies = [];
        let goal = { x: 700, y: 300 };
        let requiredCoins = 3;
        let spawnPoint = { x: 50, y: 300 };
        
        // ==================== CANVAS SETUP ====================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        // ==================== SCREEN MANAGEMENT ====================
        function showScreen(screenId) {
            document.querySelectorAll('#mainMenu, #howToPlay, #controls, #gameScreen').forEach(el => {
                el.classList.add('hidden');
            });
            document.getElementById(screenId).classList.remove('hidden');
            
            if (screenId === 'gameScreen') {
                resizeCanvas();
                gameState = 'playing';
            } else {
                gameState = 'menu';
            }
        }
        
        function hideOverlays() {
            document.querySelectorAll('#levelComplete, #gameOver, #pauseMenu, #mapComplete, #victory').forEach(el => {
                el.classList.add('hidden');
            });
            isPaused = false;
            gameState = 'menu';
        }
        
        // ==================== GAME FUNCTIONS ====================
        function startGame() {
            currentMap = 0;
            currentLevel = 0;
            hearts = 3;
            coins = 0;
            totalCoins = 0;
            loadLevel();
            showScreen('gameScreen');
            updateUI();
        }
        
        function loadLevel() {
            const map = maps[currentMap];
            const level = map.levels[currentLevel];
            
            platforms = level.platforms.map(p => ({...p}));
            levelCoins = level.coins.map(c => ({...c, collected: false}));
            enemies = level.enemies.map(e => ({
                ...e,
                startX: e.x,
                y: e.y,
                direction: 1,
                jumpTimer: 0
            }));
            goal = {...level.goal};
            requiredCoins = level.required;
            spawnPoint = {...level.spawn};
            coins = 0;
            
            resetPlayer();
            updateUI();
        }
        
        function resetPlayer() {
            player.x = spawnPoint.x;
            player.y = spawnPoint.y;
            player.vx = 0;
            player.vy = 0;
            player.grounded = false;
            player.crouching = false;
        }
        
        function updateUI() {
            // Hearts
            const heartsEl = document.getElementById('hearts');
            heartsEl.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const heart = document.createElement('span');
                heart.className = 'heart text-2xl';
                heart.textContent = i < hearts ? '‚ù§Ô∏è' : 'üñ§';
                heartsEl.appendChild(heart);
            }
            
            // Coins
            document.getElementById('coinCount').textContent = coins;
            document.getElementById('coinRequired').textContent = requiredCoins;
            
            // Map/Level
            document.getElementById('mapLevel').textContent = 
                `${maps[currentMap].name.toUpperCase()} - LEVEL ${currentLevel + 1}`;
        }
        
        function pauseGame() {
            isPaused = true;
            document.getElementById('pauseMenu').classList.remove('hidden');
        }
        
        function resumeGame() {
            isPaused = false;
            document.getElementById('pauseMenu').classList.add('hidden');
        }
        
        function restartLevel() {
            hideOverlays();
            levelCoins.forEach(c => c.collected = false);
            coins = 0;
            resetPlayer();
            updateUI();
            gameState = 'playing';
        }
        
        function restartGame() {
            hideOverlays();
            startGame();
        }
        
        function nextLevel() {
            hideOverlays();
            currentLevel++;
            
            if (currentLevel >= maps[currentMap].levels.length) {
                // Map complete
                if (currentMap < maps.length - 1) {
                    document.getElementById('mapComplete').classList.remove('hidden');
                    gameState = 'mapComplete';
                } else {
                    // Game complete!
                    document.getElementById('totalCoins').textContent = totalCoins;
                    document.getElementById('victory').classList.remove('hidden');
                    gameState = 'victory';
                }
            } else {
                loadLevel();
                gameState = 'playing';
            }
        }
        
        function nextMap() {
            hideOverlays();
            currentMap++;
            currentLevel = 0;
            hearts = 3; // Restore all hearts when advancing to a new map
            loadLevel();
            updateUI();
            gameState = 'playing';
        }
        
        function loseHeart() {
            hearts--;
            
            if (hearts <= 0) {
                document.getElementById('finalScore').textContent = totalCoins;
                document.getElementById('gameOver').classList.remove('hidden');
                gameState = 'gameover';
            } else {
                // Reset level
                levelCoins.forEach(c => c.collected = false);
                coins = 0;
                resetPlayer();
                updateUI();
            }
        }
        
        function completeLevel() {
            totalCoins += coins;
            document.getElementById('levelComplete').classList.remove('hidden');
            gameState = 'levelComplete';
        }
        
        // ==================== GAME LOOP ====================
        function update() {
            if (gameState !== 'playing' || isPaused) return;
            
            const map = maps[currentMap];
            
            // Player input
            if (keys.C) player.vx = -player.speed;
            else if (keys.E) player.vx = player.speed;
            else player.vx *= 0.8;
            
            if (keys.D && player.grounded) {
                player.vy = player.jumpForce;
                player.grounded = false;
            }
            
            // Dash
            if (keys.F && player.dashCooldown <= 0) {
                player.vx = (player.facingRight ? 1 : -1) * player.speed * 4;
                player.dashCooldown = 30;
            }
            if (player.dashCooldown > 0) player.dashCooldown--;
            
            // Crouch
            player.crouching = keys.G && player.grounded;
            player.height = player.crouching ? 25 : 40;
            
            // Track facing direction
            if (player.vx > 0.1) player.facingRight = true;
            if (player.vx < -0.1) player.facingRight = false;
            
            // Apply gravity
            player.vy += player.gravity;
            
            // Move player
            player.x += player.vx;
            player.y += player.vy;
            
            // Platform collision
            player.grounded = false;
            for (const plat of platforms) {
                if (player.x + player.width > plat.x && 
                    player.x < plat.x + plat.w &&
                    player.y + player.height > plat.y &&
                    player.y + player.height < plat.y + plat.h + 15 &&
                    player.vy >= 0) {
                    player.y = plat.y - player.height;
                    player.vy = 0;
                    player.grounded = true;
                }
            }
            
            // Screen bounds
            if (player.x < 0) player.x = 0;
            if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
            
            // Fall off screen
            if (player.y > canvas.height) {
                loseHeart();
                return;
            }
            
            // Coin collection
            for (const coin of levelCoins) {
                if (!coin.collected) {
                    const dx = (player.x + player.width/2) - coin.x;
                    const dy = (player.y + player.height/2) - coin.y;
                    if (Math.sqrt(dx*dx + dy*dy) < 25) {
                        coin.collected = true;
                        coins++;
                        updateUI();
                        // Play coin sound
                        playSoundEffect('coin');
                    }
                }
            }
            
            // Enemy update and collision
            for (const enemy of enemies) {
                // Movement
                if (enemy.type === 'walker' || enemy.type === 'crystal') {
                    enemy.x += enemy.direction * 1.5;
                    if (Math.abs(enemy.x - enemy.startX) > enemy.range) {
                        enemy.direction *= -1;
                    }
                }
                
                if (enemy.type === 'jumper') {
                    enemy.x += enemy.direction * 1;
                    if (Math.abs(enemy.x - enemy.startX) > enemy.range) {
                        enemy.direction *= -1;
                    }
                    enemy.jumpTimer++;
                    if (enemy.jumpTimer > 60) {
                        enemy.jumpTimer = 0;
                    }
                }
                
                // Collision with player
                const ex = enemy.x;
                const ey = enemy.y - (enemy.type === 'jumper' && enemy.jumpTimer < 30 ? Math.sin(enemy.jumpTimer/30 * Math.PI) * 30 : 0);
                const ew = 30;
                const eh = 30;
                
                if (player.x + player.width > ex - ew/2 &&
                    player.x < ex + ew/2 &&
                    player.y + player.height > ey - eh &&
                    player.y < ey) {
                    loseHeart();
                    return;
                }
            }
            
            // Goal check
            const dx = (player.x + player.width/2) - goal.x;
            const dy = (player.y + player.height/2) - goal.y;
            if (Math.sqrt(dx*dx + dy*dy) < 40 && coins >= requiredCoins) {
                completeLevel();
            }
        }
        
        function draw() {
            const map = maps[currentMap];
            
            // Clear and draw background
            ctx.fillStyle = map.bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw background decorations
            ctx.fillStyle = 'rgba(255,255,255,0.1)';
            for (let i = 0; i < 5; i++) {
                ctx.beginPath();
                ctx.arc(100 + i * 180, 80 + Math.sin(Date.now()/1000 + i) * 20, 30, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Draw platforms
            for (const plat of platforms) {
                ctx.fillStyle = map.platformColor;
                ctx.fillRect(plat.x, plat.y, plat.w, plat.h);
                
                // Platform top highlight
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(plat.x, plat.y, plat.w, 4);
                
                // Grass/detail on top
                if (map.name === "Grasslands") {
                    ctx.fillStyle = '#32CD32';
                    for (let x = plat.x; x < plat.x + plat.w; x += 10) {
                        ctx.fillRect(x, plat.y - 3, 2, 5);
                    }
                }
            }
            
            // Draw coins
            for (const coin of levelCoins) {
                if (!coin.collected) {
                    const bobY = Math.sin(Date.now() / 200 + coin.x) * 3;
                    
                    // Coin glow
                    ctx.fillStyle = 'rgba(255, 215, 0, 0.3)';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y + bobY, 18, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Coin
                    ctx.fillStyle = '#FFD700';
                    ctx.beginPath();
                    ctx.arc(coin.x, coin.y + bobY, 12, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Coin shine
                    ctx.fillStyle = '#FFF8DC';
                    ctx.beginPath();
                    ctx.arc(coin.x - 3, coin.y + bobY - 3, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            // Draw enemies
            for (const enemy of enemies) {
                const jumpOffset = enemy.type === 'jumper' && enemy.jumpTimer < 30 ? 
                    Math.sin(enemy.jumpTimer/30 * Math.PI) * 30 : 0;
                const ey = enemy.y - jumpOffset;
                
                // Enemy shadow
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.beginPath();
                ctx.ellipse(enemy.x, enemy.y + 5, 15, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                
                if (enemy.type === 'walker') {
                    // Slime enemy
                    ctx.fillStyle = '#FF6B6B';
                    ctx.beginPath();
                    ctx.ellipse(enemy.x, ey - 10, 18, 15, 0, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Eyes
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(enemy.x - 6, ey - 12, 5, 0, Math.PI * 2);
                    ctx.arc(enemy.x + 6, ey - 12, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = 'black';
                    ctx.beginPath();
                    ctx.arc(enemy.x - 5 + enemy.direction * 2, ey - 12, 2, 0, Math.PI * 2);
                    ctx.arc(enemy.x + 7 + enemy.direction * 2, ey - 12, 2, 0, Math.PI * 2);
                    ctx.fill();
                } else if (enemy.type === 'jumper') {
                    // Bouncy enemy
                    ctx.fillStyle = '#9B59B6';
                    ctx.beginPath();
                    ctx.arc(enemy.x, ey - 15, 15, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Spring
                    ctx.strokeStyle = '#7D3C98';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(enemy.x, ey);
                    for (let i = 0; i < 3; i++) {
                        ctx.lineTo(enemy.x + 5, ey + i * 5 - jumpOffset/3);
                        ctx.lineTo(enemy.x - 5, ey + i * 5 + 2 - jumpOffset/3);
                    }
                    ctx.stroke();
                    
                    // Eyes
                    ctx.fillStyle = 'white';
                    ctx.beginPath();
                    ctx.arc(enemy.x - 5, ey - 17, 4, 0, Math.PI * 2);
                    ctx.arc(enemy.x + 5, ey - 17, 4, 0, Math.PI * 2);
                    ctx.fill();
                } else if (enemy.type === 'crystal') {
                    // Crystal enemy
                    ctx.fillStyle = '#00CED1';
                    ctx.beginPath();
                    ctx.moveTo(enemy.x, ey - 30);
                    ctx.lineTo(enemy.x + 15, ey - 10);
                    ctx.lineTo(enemy.x + 10, ey);
                    ctx.lineTo(enemy.x - 10, ey);
                    ctx.lineTo(enemy.x - 15, ey - 10);
                    ctx.closePath();
                    ctx.fill();
                    
                    // Shine
                    ctx.fillStyle = 'rgba(255,255,255,0.5)';
                    ctx.beginPath();
                    ctx.moveTo(enemy.x - 5, ey - 25);
                    ctx.lineTo(enemy.x + 5, ey - 15);
                    ctx.lineTo(enemy.x, ey - 10);
                    ctx.closePath();
                    ctx.fill();
                }
            }
            
            // Draw goal flag
            const flagWave = Math.sin(Date.now() / 200) * 5;
            
            // Flag pole
            ctx.fillStyle = '#8B4513';
            ctx.fillRect(goal.x - 3, goal.y - 60, 6, 70);
            
            // Flag
            if (coins >= requiredCoins) {
                ctx.fillStyle = '#32CD32';
            } else {
                ctx.fillStyle = '#DC143C';
            }
            ctx.beginPath();
            ctx.moveTo(goal.x + 3, goal.y - 55);
            ctx.lineTo(goal.x + 40 + flagWave, goal.y - 45);
            ctx.lineTo(goal.x + 3, goal.y - 35);
            ctx.closePath();
            ctx.fill();
            
            // Star on flag
            ctx.fillStyle = '#FFD700';
            ctx.font = '12px Arial';
            ctx.fillText('‚òÖ', goal.x + 15, goal.y - 42);
            
            // Draw player
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height);
            if (!player.facingRight) ctx.scale(-1, 1);
            
            // Player shadow
            ctx.fillStyle = 'rgba(0,0,0,0.3)';
            ctx.beginPath();
            ctx.ellipse(0, 0, player.width/2, 5, 0, 0, Math.PI * 2);
            ctx.fill();
            
            // Body
            ctx.fillStyle = player.color;
            if (player.crouching) {
                ctx.fillRect(-player.width/2, -player.height, player.width, player.height);
            } else {
                ctx.fillRect(-player.width/2, -player.height, player.width, player.height);
            }
            
            // Face
            ctx.fillStyle = '#FFE4C4';
            ctx.fillRect(-player.width/2 + 5, -player.height + 5, player.width - 10, 15);
            
            // Eyes
            ctx.fillStyle = 'black';
            ctx.fillRect(-3, -player.height + 8, 3, 4);
            ctx.fillRect(5, -player.height + 8, 3, 4);
            
            // Music note on shirt
            ctx.fillStyle = 'white';
            ctx.font = '12px Arial';
            ctx.fillText('‚ô™', -5, -player.height + 30);
            
            ctx.restore();
            
            // Draw instructions if needed
            if (currentMap === 0 && currentLevel === 0 && coins === 0) {
                ctx.fillStyle = 'rgba(0,0,0,0.7)';
                ctx.fillRect(canvas.width/2 - 150, 20, 300, 60);
                ctx.fillStyle = 'white';
                ctx.font = '12px "Press Start 2P", monospace';
                ctx.textAlign = 'center';
                ctx.fillText('Play the piano below', canvas.width/2, 45);
                ctx.fillText('to move your character!', canvas.width/2, 65);
                ctx.textAlign = 'left';
            }
        }
        
        function gameLoop() {
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
        
        // ==================== INITIALIZATION ====================
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        gameLoop();
    </script>
</body>
</html>
